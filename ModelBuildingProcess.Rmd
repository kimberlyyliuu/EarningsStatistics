---
title: "Model Building Process"
output: pdf_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, highlight=FALSE, comment=NA, warnings=FALSE,message=FALSE)
```

```{r, echo=FALSE, warning=FALSE,results=FALSE}
## Use this chunk for reading in packages.
## Use this chunk for reading in the data, combining the data, and any other major data cleaning that is not relevant to show.
## Remove the ## before all code.
incomeData<-read.csv("https://raw.githubusercontent.com/kimberlyyliuu/STAT3220Project/main/completeData")
library(ggplot2)
library(dplyr)
library(ggthemes)
if (!requireNamespace("cowplot", quietly = TRUE)) {
  install.packages("cowplot")
}
library(cowplot)
library(corrplot)
library(olsrr)
library(car)
library(caret)
```

```{r, results=F}
## From the EDA, we saw that the level "Bachelors" for H_ED only had one response. It also had significantly higher PEARNVAL than any other response. To prevent extrapolation and excessive skew, we should remove this from the data, especially if we are going to use H_ED as a predictor in the model
#Displaying unequal responses to levels: 
incomeData |>
  group_by(H_ED) |>
  summarise(count=n())
#Subsetting out DC: 
incomeData<-incomeData |>
  filter(STATEFIPS != 11)

hist(incomeData$PEARNVAL)
##EDA to explore variables in relation to the response, PEARNVAL
#Scatter plots for quantitative:
par(mfrow = c(2, 3))
plot(incomeData$AGE,incomeData$PEARNVAL,xlab="AGE",ylab="PEARNVAL")
plot(incomeData$UNEMP_RATE,incomeData$PEARNVAL,xlab="UNEMP_RATE",ylab="PEARNVAL")
plot(incomeData$TAX_RTE,incomeData$PEARNVAL,xlab="TAX_RTE",ylab="PEARNVAL")
plot(incomeData$URB_PER,incomeData$PEARNVAL,xlab="URB_PER",ylab="PEARNVAL")
plot(incomeData$WRK_SPND,incomeData$PEARNVAL,xlab="WRK_SPND",ylab="PEARNVAL")

#Boxplots for qualitative:
par(mfrow=c(1,3))
boxplot(PEARNVAL~H_ED,data=incomeData)
boxplot(PEARNVAL~SEX,data=incomeData)
boxplot(PEARNVAL~HEA,data=incomeData)

##Model with all predictors: 
incomemod1<-lm(PEARNVAL~AGE+UNEMP_RATE+TAX_RTE+URB_PER+WRK_SPND+HEA+SEX+H_ED,data=incomeData)
summary(incomemod1)
#Results in a globally significant model

##Checking first model for influential observations:
influencePlot(incomemod1)
#Using the Studentized residual threshold of an absolute value of 2, there are 2 outliers, corresponding to observations 9 and 11.

residualPlots(incomemod1,tests=F)
#Looking at residual plot, there appears to be a fanning relationship with residuals for UNEMP_RATE and potentially WRK_SPND

plot(incomemod1,which=2)
#QQplot is approximately linear

hist(residuals(incomemod1))
#residuals are approximately normally distributed

##Checking for multicollinearity
cor(incomeData[7:11])
quantincomeData<-incomeData[7:11]
corrplot(cor(quantincomeData))
#No significant multicollinearity between quantitative variables

##Building a model using step wise regression
ols_step_both_p(incomemod1,pent=0.15,prem=0.15,details=T)
incomemod2<-lm(PEARNVAL~H_ED+URB_PER,data=incomeData)
summary(incomemod2)
#Results in a globally significant model

##Checking second model for influential observations:
influencePlot(incomemod2)
#Again, two influential observations (11 and 21)

residualPlots(incomemod2,tests=F)
#No problems with residuals

plot(incomemod2,which=2)
#Approximate linearity, but worse than first model

hist(residuals(incomemod2))
#Residuals approximately normal, but distribution worse (less normal) than first model

##Building a third model with our 3 important var from part I of the project:
incomemod3<-lm(PEARNVAL~H_ED+HEA+AGE,data=incomeData)
summary(incomemod3)
#Globally significant model, but HEA and AGE are individually insignificant
```


Stage 1 - Quantitative Variables

Initial: $PEARNVAL = \beta_0 + \beta_1UNEMP\_RATE + \beta_2TAX\_RTE +\beta_3URB\_PER + \beta_4WRK\_SPND$

```{r}
incomemods1<-lm(PEARNVAL~UNEMP_RATE+TAX_RTE+URB_PER+WRK_SPND,data=incomeData)
summary(incomemods1)
```

Final: $PEARNVAL = \beta_0 + \beta_1URB\_PER + \beta_2WRK\_SPND$

Stage 2 - Qualitative Variables
 
Initial: $PEARNVAL = \beta_0 + \beta_1URB\_PER + \beta_2WRK\_SPND + \beta_3H\_EDassociates + \beta_4HEAverygoodhealth$

```{r}
incomemods2<-lm(PEARNVAL~URB_PER+WRK_SPND+H_ED+HEA,data=incomeData)
summary(incomemods2)
```

Final: $PEARNVAL = \beta_0 + \beta_1URB\_PER + \beta_2H\_EDassociates$

```{r}
incomemodfinal<-lm(PEARNVAL~URB_PER+H_ED,data=incomeData)
summary(incomemodfinal)
```

Stage 3 - Interactions
There are no interactions believed to be influencing the data. 

```{r}
ggplot(incomeData, aes(x = URB_PER, y = PEARNVAL, color = H_ED)) +
  geom_point() +
  labs(x = "Urban Percentage", y = "Personal Earnings", title = "Scatterplot of Personal Earnings by Urban Percentage and Education")
```

Checking the model with stepwise regression: 
```{r}
ols_step_both_p(incomemodfinal,pent=0.15,prem=0.15,details=T)
#Yipeee!!! the model resulting from this method (consider the EDA) matches the model generated by just throwing all the explanatory var in and building stepwise.
#(so that means the model building process is pretty sound)
#The model itself is lowkey mid tho
```

Checking assumptions: 
```{r}
#Lack of Fit: 
residualPlots(incomemodfinal)
#Consant Variance
residualPlots(incomemodfinal,tests=F)
plot(incomemodfinal,which=1)
#Normality: 
plot(incomemodfinal,which=2)
hist(residuals(incomemodfinal))
#potentially violated:

#NEW TRANSFORMED MODEL
revisedincomemod<-lm(PEARNVAL^2~URB_PER+H_ED,data=incomeData)

##REVISED MODEL 
#Lack of Fit: 
residualPlots(revisedincomemod)
#no lack of fit 

#Constant Variance
residualPlots(revisedincomemod,tests=F)
plot(revisedincomemod,which=1)
#Normality: 
plot(revisedincomemod,which=2)
hist(residuals(revisedincomemod))
```


Constant Variance: 


```{r}
##Checking final model for influential observations:
influencePlot(incomemodfinal)
#Using the Studentized residual threshold of an absolute value of 2, there are 2 outliers, corresponding to observations 9 and 11.

residualPlots(incomemodfinal,tests=F)
#Looking at residual plot, there appears to be a fanning relationship with residuals for UNEMP_RATE and potentially WRK_SPND

plot(incomemodfinal,which=2)
#QQplot is approximately linear

hist(residuals(incomemodfinal))
#residuals are approximately normally distributed
```


Remove observations 11, 19, 45, 21
```{r}
subsetincomeData<-incomeData[-c(11,19,45,21),]
subsetincomemod<-lm(PEARNVAL~URB_PER+H_ED,data=subsetincomeData)
summary(subsetincomemod)
```

$PEARNVAL = \beta_0 + \beta_1URB\_PER + \beta_2H\_EDvocationalassociates$
$PEARNVAL = 47408.52 + 191.95URB\_PER -7017.40H\_EDvocationalassociates$

For Virginia: URB_PER = 75.5; H_EDvocationalassociates = 0
```{r}
47408.52 + 191.95*75.5 - 7017.40*0
```
Predicted value: 61900.74
Actual Value: 71818.63
